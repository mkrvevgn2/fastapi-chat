<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ß–∞—Ç —Å –∑–∞–≥—Ä—É–∑–∫–æ–π —Ñ–∞–π–ª–æ–≤</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #chat { height: 70vh; overflow-y: auto; padding: 10px; border-bottom: 1px solid #ccc; }
    #form { display: flex; flex-direction: column; padding: 10px; gap: 5px; }
    .message { margin-bottom: 10px; }
    .meta { font-size: 0.8em; color: #666; }
    .preview img { max-height: 100px; margin: 5px; }
  </style>
</head>
<body>

<h2>üì¢ –ß–∞—Ç</h2>
<div id="chat"></div>

<div id="form">
  <input type="text" id="username" placeholder="–ò–º—è (–ø–æ –∂–µ–ª–∞–Ω–∏—é)">
  <input type="file" id="fileInput" multiple>
  <div id="fileList" class="preview"></div>
  <textarea id="msg" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="3"></textarea>
  <button onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  <div id="status"></div>
</div>

<script>
  const SERVER_BASE_URL = "https://ba17-34-16-171-22.ngrok-free.app"; // ‚Üê –£–∫–∞–∂–∏ –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞!
  const ws = new WebSocket(SERVER_BASE_URL.replace("https", "wss") + "/ws/chat");

  const chat = document.getElementById("chat");
  const usernameInput = document.getElementById("username");
  const fileInput = document.getElementById("fileInput");
  const fileList = document.getElementById("fileList");
  const status = document.getElementById("status");

  let latitude = null, longitude = null;
  let selectedFiles = [];
  const sessionId = crypto.randomUUID();
  const avatarURL = https://api.dicebear.com/7.x/thumbs/svg?seed=${sessionId};

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
  navigator.geolocation?.getCurrentPosition(
    (pos) => {
      latitude = pos.coords.latitude;
      longitude = pos.coords.longitude;
    },
    () => { console.warn("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞"); }
  );

  // –í—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π
  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.user_count !== undefined) {
      status.textContent = üë• –û–Ω–ª–∞–π–Ω: ${data.user_count};
      return;
    }

    const msgEl = document.createElement("div");
    msgEl.className = "message";
    msgEl.innerHTML = 
      <div class="meta">
        üïí ${data.timestamp} | üë§ <b>${data.username}</b>
        ${data.distance_km != null ?  | üìç${data.distance_km} –∫–º : ""}
      </div>
      <div>${data.message}</div>
    ;
    chat.appendChild(msgEl);
    chat.scrollTop = chat.scrollHeight;
  };

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
  fileInput.addEventListener("change", () => {
    selectedFiles = Array.from(fileInput.files);
    renderFileList();
  });

  function renderFileList() {
    fileList.innerHTML = "";
    for (const file of selectedFiles) {
      const div = document.createElement("div");
      if (file.type.startsWith("image/")) {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        div.appendChild(img);
      } else {
        div.textContent = üìÑ ${file.name};
      }
      fileList.appendChild(div);
    }
  }

  async function send() {
    const username = usernameInput.value || "–ê–Ω–æ–Ω–∏–º";
    const messageInput = document.getElementById("msg");
    let message = messageInput.value.trim();

    if (!message && selectedFiles.length === 0) return;

    const payload = {
      sessionId,
      username,
      message,
      latitude,
      longitude,
      avatar: avatarURL
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
    if (selectedFiles.length > 0) {
      const formData = new FormData();
      selectedFiles.forEach((file) => {
        formData.append("files", file);
      });
      formData.append("username", username);

      try {
        const response = await fetch(SERVER_BASE_URL + "/upload", {
          method: "POST",
          body: formData
        });
        const data = await response.json();

        if (data.saved && data.saved.length > 0) {
          const links = data.saved.map(url => {
            const fullUrl = SERVER_BASE_URL + url;
            const name = decodeURIComponent(url.split("/").pop());
            return <a href="${fullUrl}" target="_blank">${name}</a>;
          }).join("<br>");
          payload.message += <br>üìé –§–∞–π–ª—ã:<br>${links};
        }
      } catch (err) {
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤.");
        return;
      }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    ws.send(JSON.stringify(payload));

    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    messageInput.value = "";
    fileInput.value = "";
    selectedFiles = [];
    renderFileList();
  }
</script>

</body>
</html>
