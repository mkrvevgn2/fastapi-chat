<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>WebSocket Chat</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
    #messages { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
    li { margin-bottom: 5px; background: #fff; padding: 8px; border-radius: 5px; display: flex; align-items: center; gap: 10px; }
    input { padding: 6px; margin-right: 5px; }
    button { padding: 6px 10px; }
    .avatar { width: 32px; height: 32px; border-radius: 50%; }
    #avatarPreview { width: 40px; height: 40px; border-radius: 50%; margin-bottom: 10px; }
    #status { color: gray; font-size: 0.9em; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>üí¨ FastAPI WebSocket Chat <span id="userCount">(0 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)</span></h2>

  <div id="status">üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
  <img id="avatarPreview" src="" alt="avatar" />
  <input id="username" placeholder="–í–∞—à–µ –∏–º—è" />
  <input id="msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" />
  <button onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

  <ul id="messages"></ul>

  <script>
    let ws;
    let latitude = null;
    let longitude = null;
    let reconnectInterval = 3000;

    const avatarSeed = Math.random().toString(36).substring(2, 10);
    const avatarURL = `https://api.dicebear.com/7.x/pixel-art/svg?seed=${avatarSeed}`;
    document.getElementById("avatarPreview").src = avatarURL;

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        latitude = pos.coords.latitude;
        longitude = pos.coords.longitude;
      },
      (err) => {
        console.warn("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞:", err.message);
      },
      { enableHighAccuracy: true, timeout: 5000 }
    );

    function connectWebSocket() {
      ws = new WebSocket("wss://12d4-35-237-91-117.ngrok-free.app/ws/chat");
      //https://12d4-35-237-91-117.ngrok-free.app
      //https://a6c8-34-53-112-5.ngrok-free.app

      ws.onopen = () => {
        document.getElementById("status").textContent = "üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ";
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ user_count
        if (data.user_count !== undefined) {
          document.getElementById("userCount").textContent = `(${data.user_count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å${data.user_count === 1 ? '' : '–µ–π'})`;
          return;
        }

        const distInfo = data.distance_km !== null ? ` (~${data.distance_km.toFixed(1)} –∫–º –æ—Ç –≤–∞—Å)` : '';

        const msg = document.createElement("li");

        const avatar = document.createElement("img");
        avatar.src = data.avatar || "";
        avatar.className = "avatar";

        const text = document.createElement("span");
        text.textContent = `[${data.timestamp}] ${data.username}: ${data.message}${distInfo}`;

        msg.appendChild(avatar);
        msg.appendChild(text);
        document.getElementById("messages").appendChild(msg);
      };

      ws.onclose = () => {
        document.getElementById("status").textContent = "üî¥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...";
        setTimeout(connectWebSocket, reconnectInterval);
      };

      ws.onerror = () => {
        document.getElementById("status").textContent = "‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.";
      };
    }

    connectWebSocket();

    function send() {
      const username = document.getElementById("username").value || "–ê–Ω–æ–Ω–∏–º";
      const message = document.getElementById("msg").value;

      if (!message.trim()) return;

      const payload = {
        username,
        message,
        latitude,
        longitude,
        avatar: avatarURL
      };

      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(payload));
        document.getElementById("msg").value = "";
      } else {
        alert("–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.");
      }
    }
  </script>
</body>
</html>


